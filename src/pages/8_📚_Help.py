"""
Phase 4 - ヘルプページ
ドキュメント、FAQ、チュートリアル
"""

import streamlit as st
import sys
from pathlib import Path

# プロジェクトルートをパスに追加
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

# ページ設定
st.set_page_config(
    page_title="ヘルプ | 購買データ分析ダッシュボード",
    page_icon="📚",
    layout="wide",
    initial_sidebar_state="expanded"
)

# カスタムCSS読み込み
css_path = project_root / "src" / "styles" / "custom.css"
if css_path.exists():
    with open(css_path) as f:
        st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)

# タイトル
st.title("📚 ヘルプ・ドキュメント")
st.markdown("### 使い方ガイドとFAQ")

# サイドバー
with st.sidebar:
    st.header("📑 目次")
    section = st.radio(
        "セクションを選択",
        [
            "🏠 はじめに",
            "🚀 クイックスタート",
            "📊 機能ガイド",
            "❓ FAQ",
            "🔧 トラブルシューティング",
            "📖 用語集",
            "📞 サポート"
        ]
    )

st.divider()

# はじめに
if section == "🏠 はじめに":
    st.header("🏠 はじめに")
    
    st.markdown("""
    ## 購買データ分析ダッシュボード Phase 4 へようこそ！
    
    このダッシュボードは、購買データの包括的な分析を行うための強力なツールです。
    
    ### 主な特徴
    
    - 📊 **多様な可視化**: 15種類以上のインタラクティブなグラフ
    - 🤖 **AI予測**: 機械学習による売上予測と顧客分析
    - 🎯 **RFM分析**: 顧客セグメンテーションと行動分析
    - 📈 **トレンド分析**: 時系列データの詳細な分析
    - 💾 **データ管理**: エクスポート、フィルタリング機能
    - ⚙️ **カスタマイズ**: 豊富な設定オプション
    
    ### Phase 4 の新機能
    
    - 🏠 **マルチページ構造**: 機能ごとに整理されたページ
    - 🤖 **AI予測分析**: 売上予測、離脱予測、レコメンデーション
    - 🔄 **リアルタイム更新**: 自動データ更新機能
    - 🔐 **セキュリティ**: 認証機能（開発中）
    - 💾 **データベース統合**: SQLite/PostgreSQL対応（開発中）
    
    ### 推奨環境
    
    - **ブラウザ**: Chrome, Firefox, Edge (最新版)
    - **画面解像度**: 1920x1080 以上推奨
    - **インターネット接続**: 必須（一部機能）
    """)

# クイックスタート
elif section == "🚀 クイックスタート":
    st.header("🚀 クイックスタート")
    
    st.markdown("""
    ## 5分で始める分析
    
    ### ステップ1: データの確認
    
    1. 🏠 **ホームページ** を開く
    2. データが正しく読み込まれているか確認
    3. 主要指標（KPI）をチェック
    
    ### ステップ2: フィルターの適用
    
    1. サイドバーの **フィルター** を開く
    2. 期間、地域、カテゴリーなどを選択
    3. データが自動的に更新される
    
    ### ステップ3: 分析の実行
    
    #### 売上分析
    ```
    📊 売上分析ページ → 月別推移グラフを確認
    ```
    
    #### 顧客分析
    ```
    👥 顧客分析ページ → 年齢分布と購買パターンを確認
    ```
    
    #### AI予測
    ```
    🤖 AI予測ページ → 売上予測を実行
    ```
    
    ### ステップ4: データのエクスポート
    
    1. 💾 **データ管理ページ** を開く
    2. エクスポート形式を選択（CSV/Excel）
    3. ダウンロードボタンをクリック
    
    ### 便利なショートカット
    
    - `Ctrl + R`: ページ更新
    - `Ctrl + S`: 設定を保存
    - `Esc`: サイドバーを閉じる
    """)
    
    st.info("💡 **ヒント**: 各ページの上部にあるフィルターを活用すると、より詳細な分析が可能です。")

# 機能ガイド
elif section == "📊 機能ガイド":
    st.header("📊 機能ガイド")
    
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "🏠 ホーム",
        "📊 売上分析",
        "👥 顧客分析",
        "🤖 AI予測",
        "📈 トレンド"
    ])
    
    with tab1:
        st.subheader("🏠 ホームページ")
        st.markdown("""
        **概要:**
        ダッシュボードの全体像を把握できるページです。
        
        **主な機能:**
        - システム概要の表示
        - 主要指標（KPI）の一覧
        - クイックインサイト
        - 最近のアクティビティ
        - システムステータス
        - クイックアクセスボタン
        
        **使い方:**
        1. ページを開くと自動的にデータが読み込まれます
        2. 各KPIカードで主要指標を確認
        3. クイックアクセスボタンで各分析ページへ移動
        """)
    
    with tab2:
        st.subheader("📊 売上分析ページ")
        st.markdown("""
        **概要:**
        売上データの詳細な分析と可視化を行います。
        
        **主な機能:**
        - 月別/日別売上推移
        - カテゴリー別売上分析
        - 地域別売上比較
        - 曜日別売上パターン
        - ヒートマップ分析
        
        **グラフの種類:**
        - 📈 折れ線グラフ: 時系列推移
        - 📊 棒グラフ: カテゴリー比較
        - 🥧 円グラフ: 構成比
        - 🔥 ヒートマップ: クロス分析
        
        **使い方:**
        1. サイドバーでフィルターを設定
        2. 各グラフにマウスオーバーで詳細表示
        3. グラフをクリックしてズーム
        4. ダブルクリックでリセット
        """)
    
    with tab3:
        st.subheader("👥 顧客分析ページ")
        st.markdown("""
        **概要:**
        顧客の行動パターンとセグメンテーション分析。
        
        **主な機能:**
        - 年齢分布と年齢層別分析
        - 性別×地域別売上
        - 購入金額分析
        - 顧客ランキング
        - リピート率分析
        
        **分析指標:**
        - ユニーク顧客数
        - 平均年齢
        - 顧客あたり平均購入回数
        - リピート率
        
        **活用例:**
        - ターゲット顧客層の特定
        - マーケティング戦略の立案
        - 顧客満足度の向上
        """)
    
    with tab4:
        st.subheader("🤖 AI予測ページ")
        st.markdown("""
        **概要:**
        機械学習を使用した高度な予測分析。
        
        **主な機能:**
        
        1. **売上予測**
           - 移動平均とトレンド分析
           - 7日〜90日間の予測
           - 信頼区間の表示
        
        2. **顧客セグメント**
           - RFM分析によるセグメント化
           - 5つのセグメント分類
           - 3D散布図による可視化
        
        3. **離脱予測**
           - 顧客離脱確率の計算
           - リスクレベルの分類
           - 推奨アクションの提示
        
        4. **レコメンデーション**
           - 人気商品の推奨
           - 顧客別レコメンデーション
        
        **予測精度:**
        - MAE (平均絶対誤差)
        - RMSE (二乗平均平方根誤差)
        - MAPE (平均絶対パーセント誤差)
        """)
    
    with tab5:
        st.subheader("📈 トレンド分析ページ")
        st.markdown("""
        **概要:**
        時系列データの詳細な分析とトレンド把握。
        
        **主な機能:**
        - 移動平均付き売上トレンド
        - 曜日別売上パターン
        - 月×カテゴリーヒートマップ
        - RFM分析
        - 自動生成インサイト
        - 期間比較分析
        
        **分析手法:**
        - 移動平均（7日、14日、30日）
        - 前月比・前年比
        - 季節性分析
        - 異常値検出
        
        **活用例:**
        - 売上トレンドの把握
        - 季節性の理解
        - 異常値の検出
        - 将来予測の基礎データ
        """)

# FAQ
elif section == "❓ FAQ":
    st.header("❓ よくある質問（FAQ）")
    
    with st.expander("Q1: データはどこから読み込まれますか？"):
        st.markdown("""
        **A:** データは `data/sample-data.csv` から読み込まれます。
        
        カスタムデータを使用する場合は、同じフォーマットのCSVファイルを配置してください。
        
        **必要な列:**
        - 顧客ID
        - 年齢
        - 性別
        - 地域
        - 購入カテゴリー
        - 購入金額
        - 購入日
        - 支払方法
        """)
    
    with st.expander("Q2: フィルターが効かない場合は？"):
        st.markdown("""
        **A:** 以下を確認してください：
        
        1. フィルターを適用した後、ページが更新されているか
        2. 選択した条件に該当するデータが存在するか
        3. ブラウザのキャッシュをクリアしてみる
        4. ページをリロード（F5）してみる
        
        それでも解決しない場合は、設定ページからキャッシュをクリアしてください。
        """)
    
    with st.expander("Q3: グラフが表示されない場合は？"):
        st.markdown("""
        **A:** 以下の対処法を試してください：
        
        1. **データの確認**: データが正しく読み込まれているか確認
        2. **ブラウザの確認**: Chrome, Firefox, Edgeの最新版を使用
        3. **JavaScript**: ブラウザでJavaScriptが有効になっているか確認
        4. **キャッシュクリア**: ブラウザのキャッシュをクリア
        5. **再起動**: アプリケーションを再起動
        """)
    
    with st.expander("Q4: 予測精度を向上させるには？"):
        st.markdown("""
        **A:** 予測精度を向上させる方法：
        
        1. **データ量を増やす**: より多くの履歴データを使用
        2. **データ品質**: 欠損値や異常値を修正
        3. **期間の選択**: 適切な予測期間を選択（短期予測の方が精度が高い）
        4. **季節性の考慮**: 季節性のあるデータは長期データが必要
        5. **外れ値の除去**: 異常なデータポイントを除外
        """)
    
    with st.expander("Q5: データをエクスポートできない場合は？"):
        st.markdown("""
        **A:** エクスポートの問題解決：
        
        1. **ブラウザの設定**: ダウンロードがブロックされていないか確認
        2. **ディスク容量**: 十分な空き容量があるか確認
        3. **権限**: ダウンロードフォルダへの書き込み権限を確認
        4. **ファイルサイズ**: 大きなデータセットの場合、フィルターで絞り込む
        5. **フォーマット変更**: 別のフォーマット（CSV→Excel）を試す
        """)
    
    with st.expander("Q6: パフォーマンスが遅い場合は？"):
        st.markdown("""
        **A:** パフォーマンス改善の方法：
        
        1. **フィルターの活用**: データを絞り込んで表示
        2. **キャッシュの利用**: 設定でキャッシュを有効化
        3. **ブラウザの最適化**: 不要なタブを閉じる
        4. **データサイズ**: 大きなデータセットは分割して分析
        5. **グラフの最適化**: 設定で最大ポイント数を調整
        """)
    
    with st.expander("Q7: 認証機能はありますか？"):
        st.markdown("""
        **A:** 認証機能は現在開発中です。
        
        **Phase 4 後半で実装予定:**
        - ユーザーログイン/ログアウト
        - パスワード管理
        - ロールベースアクセス制御
        - セッション管理
        
        リリース予定については、開発計画をご確認ください。
        """)

# トラブルシューティング
elif section == "🔧 トラブルシューティング":
    st.header("🔧 トラブルシューティング")
    
    st.markdown("""
    ## 一般的な問題と解決方法
    
    ### ❌ エラーメッセージが表示される
    
    **症状:** 赤いエラーメッセージが表示される
    
    **解決方法:**
    1. エラーメッセージの内容を確認
    2. データファイルが存在するか確認
    3. ファイルのフォーマットが正しいか確認
    4. アプリケーションを再起動
    
    ### 🐌 動作が遅い
    
    **症状:** ページの読み込みやグラフの描画が遅い
    
    **解決方法:**
    1. フィルターでデータを絞り込む
    2. ブラウザのキャッシュをクリア
    3. 不要なタブを閉じる
    4. 設定でキャッシュを有効化
    5. グラフの最大ポイント数を減らす
    
    ### 📊 グラフが正しく表示されない
    
    **症状:** グラフが空白、または正しく描画されない
    
    **解決方法:**
    1. データが存在するか確認
    2. フィルター条件を緩和
    3. ブラウザを変更（Chrome推奨）
    4. JavaScriptが有効か確認
    5. ページをリロード
    
    ### 💾 データが読み込めない
    
    **症状:** "データが読み込めませんでした" というメッセージ
    
    **解決方法:**
    1. `data/sample-data.csv` が存在するか確認
    2. ファイルのパスが正しいか確認
    3. ファイルの権限を確認
    4. CSVフォーマットが正しいか確認
    5. 文字エンコーディングを確認（UTF-8推奨）
    
    ### 🔄 自動更新が動作しない
    
    **症状:** 設定した間隔でデータが更新されない
    
    **解決方法:**
    1. 設定ページで自動更新が有効か確認
    2. 更新間隔の設定を確認
    3. ブラウザの設定を確認
    4. 手動でページをリロード
    
    ### 📥 エクスポートできない
    
    **症状:** ダウンロードボタンが動作しない
    
    **解決方法:**
    1. ブラウザのダウンロード設定を確認
    2. ポップアップブロッカーを無効化
    3. 別のフォーマットを試す
    4. データサイズを確認（大きすぎる場合は分割）
    5. ディスク容量を確認
    
    ## エラーコード一覧
    
    | コード | 説明 | 対処法 |
    |--------|------|--------|
    | E001 | データファイルが見つかりません | ファイルパスを確認 |
    | E002 | データフォーマットエラー | CSVフォーマットを確認 |
    | E003 | メモリ不足 | データを絞り込む |
    | E004 | 予測エラー | データ量を確認 |
    | E005 | エクスポートエラー | 権限とディスク容量を確認 |
    
    ## サポートが必要な場合
    
    上記の方法で解決しない場合は、以下の情報を含めてサポートに連絡してください：
    
    - エラーメッセージの全文
    - 使用しているブラウザとバージョン
    - 実行した操作の手順
    - データファイルのサイズと形式
    - スクリーンショット（可能な場合）
    """)

# 用語集
elif section == "📖 用語集":
    st.header("📖 用語集")
    
    st.markdown("""
    ## 分析用語
    
    ### RFM分析
    **Recency（最新性）**: 最後の購入からの経過日数  
    **Frequency（頻度）**: 購入回数  
    **Monetary（金額）**: 総購入金額  
    
    顧客を3つの指標で評価し、セグメント化する手法。
    
    ### KPI (Key Performance Indicator)
    重要業績評価指標。ビジネスの成功を測定するための主要な指標。
    
    ### 移動平均
    一定期間のデータの平均値を計算し、トレンドを把握する手法。
    
    ### 信頼区間
    予測値の信頼できる範囲。95%信頼区間は、真の値が95%の確率でこの範囲に含まれることを示す。
    
    ### チャーン（離脱）
    顧客が製品やサービスの使用を停止すること。
    
    ### セグメンテーション
    顧客を特定の基準で分類すること。
    
    ## 統計用語
    
    ### MAE (Mean Absolute Error)
    平均絶対誤差。予測値と実際の値の差の絶対値の平均。
    
    ### RMSE (Root Mean Squared Error)
    二乗平均平方根誤差。予測精度を測る指標。
    
    ### MAPE (Mean Absolute Percentage Error)
    平均絶対パーセント誤差。予測誤差をパーセンテージで表現。
    
    ### R² (決定係数)
    モデルの説明力を示す指標。1に近いほど良い。
    
    ### 相関係数
    2つの変数間の関係の強さを示す指標。-1から1の値を取る。
    
    ### 標準偏差
    データのばらつきを示す指標。
    
    ## 技術用語
    
    ### キャッシュ
    データを一時的に保存し、再利用することで処理を高速化する仕組み。
    
    ### API (Application Programming Interface)
    アプリケーション間でデータをやり取りするためのインターフェース。
    
    ### CSV (Comma-Separated Values)
    カンマで区切られたテキスト形式のデータファイル。
    
    ### データベース
    データを構造化して保存・管理するシステム。
    
    ### レスポンシブデザイン
    画面サイズに応じて表示を最適化するデザイン手法。
    
    ### WebGL
    ブラウザ上で高速な3Dグラフィックスを描画する技術。
    """)

# サポート
elif section == "📞 サポート":
    st.header("📞 サポート")
    
    st.markdown("""
    ## お問い合わせ
    
    ### 📧 メールサポート
    技術的な質問やバグ報告は以下のメールアドレスまで：
    
    **Email:** support@dashboard-analytics.com  
    **対応時間:** 平日 9:00-18:00 (JST)  
    **返信:** 1-2営業日以内
    
    ### 💬 コミュニティ
    
    **GitHub Issues:**  
    バグ報告や機能リクエストは GitHubでお願いします。
    
    **フォーラム:**  
    ユーザー同士で情報交換できるコミュニティフォーラム。
    
    ### 📚 ドキュメント
    
    - **ユーザーガイド:** 詳細な使い方ガイド
    - **API ドキュメント:** 開発者向けAPI仕様
    - **リリースノート:** 最新の更新情報
    
    ### 🎓 トレーニング
    
    **オンライントレーニング:**  
    ダッシュボードの効果的な使い方を学べるオンラインコース。
    
    **ウェビナー:**  
    定期的に開催される無料のウェビナー。
    
    ### 🐛 バグ報告
    
    バグを発見した場合は、以下の情報を含めて報告してください：
    
    1. **再現手順:** バグが発生する手順
    2. **期待される動作:** 本来どう動作すべきか
    3. **実際の動作:** 実際にどう動作したか
    4. **環境情報:** ブラウザ、OS、バージョン
    5. **スクリーンショット:** 可能な場合
    
    ### 💡 機能リクエスト
    
    新機能の提案は大歓迎です！以下の情報を含めて送信してください：
    
    1. **機能の説明:** どんな機能か
    2. **ユースケース:** どんな場面で使うか
    3. **期待される効果:** どんなメリットがあるか
    
    ### 📊 フィードバック
    
    ダッシュボードの改善のため、フィードバックをお待ちしています。
    """)
    
    st.divider()
    
    # フィードバックフォーム
    st.subheader("📝 フィードバックフォーム")
    
    with st.form("feedback_form"):
        feedback_type = st.selectbox(
            "フィードバックの種類",
            ["バグ報告", "機能リクエスト", "改善提案", "その他"]
        )
        
        subject = st.text_input("件名")
        
        message = st.text_area(
            "詳細",
            height=150,
            placeholder="詳細な説明をお願いします..."
        )
        
        email = st.text_input(
            "メールアドレス（任意）",
            placeholder="example@email.com"
        )
        
        submitted = st.form_submit_button("送信", use_container_width=True)
        
        if submitted:
            if subject and message:
                st.success("✅ フィードバックを送信しました。ありがとうございます！")
            else:
                st.error("❌ 件名と詳細を入力してください。")

# フッター
st.divider()
st.caption("📚 ヘルプページ | Phase 4")

